(function () {
	var obj =  function (env, pkg, server, isSSL) {
		let me = this;
		me.mapping = {};
		
		me.domainList =  function() {
			let me = this, DS_m = {}, DS_d = {}, DS = {};	
			delete require.cache[env.config_path + '/main_dns.json'];
			delete require.cache[env.config_path + '/dynamic_dns.json'];
			try { 
				DS_m = require(env.config_path + '/main_dns.json'); 
			    	DS_d = require(env.config_path + '/dynamic_dns.json');
			} catch(e) {}
			Object.assign(DS, DS_m, DS_d);
			return DS;
		};
		
		me.io = require( env.root_path + '/package/socket_io/node_modules/socket.io').listen(server);
		me.io.on("connection", (socket) => {
			let me = this;
			var host = (!socket || !socket.handshake || !socket.handshake.headers) ? '' : socket.handshake.headers.host;
			if (pkg.comm.isIp(host)) {
				return true;
			}
			delete require.cache[env.root_path + '/modules/io/node_modules/ioApp.js'];
			let ioAPP =  require(env.root_path + '/modules/io/node_modules/ioApp.js');
			try {
				new ioAPP(env, pkg, server, host, isSSL).onConnection(me, socket);
			} catch (err) {
				me.io.to(socket.id).emit('ioAppError', err.mrssage);
				socket.disconnect();
			}
		});		
	};
	
	if (typeof module !== 'undefined' && typeof module.exports !== 'undefined') {
		module.exports = obj;
	} 
	
})();
