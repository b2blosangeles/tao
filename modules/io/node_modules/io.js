(function () {
	function _getServerIP() {
	    var ifaces = require('os').networkInterfaces(), address=[];
	    for (var dev in ifaces) {
		var v =  ifaces[dev].filter((details) => details.family === 'IPv4' && details.internal === false);
		for (var i=0; i < v.length; i++) address[address.length] = v[i].address;
	    }
	    return address;
	};	
	var obj =  function (env, pkg, server) {
		let me = this;
		me.io = require( env.root_path + '/package/socket_io/node_modules/socket.io').listen(server);
		var socketNodeClient = require(env.root_path + '/package/socketNodeClient/socketNodeClient.js');
		
		delete require.cache[env.root_path + '/package/socketNodeClient/socketNodeClient.js'];
		var socketNodeClient = require(env.root_path + '/package/socketNodeClient/socketNodeClient.js');
		
		let sequenceNumberByClient = new Map();	
		
		this.getCluster = function (host) {
			let me = this, DS_m = {}, DS_d = {}, DS = {};	
			delete require.cache[env.config_path + '/main_dns.json'];	
			try { DS_m = require(env.config_path + '/main_dns.json'); } catch(e) {}
			
			delete require.cache[env.config_path + '/dynamic_dns.json'];	
			try { DS_d = require(env.config_path + '/dynamic_dns.json'); } catch(e) {}
			
			Object.assign(DS, DS_m, DS_d);
			if (!DS[host]) return [];
			let list = {}
			for(o in DS) {
				if (
					(host.match(/^comm([0-9]+)\_dev\.([a-z0-9]+)\.([a-z0-9]+)$/ig) &&
						o.match(/^comm([0-9]+)\_dev\.([a-z0-9]+)\.([a-z0-9]+)$/ig)) 
					|| (host.match(/^comm([0-9]+)\_prod\.([a-z0-9]+)\.([a-z0-9]+)$/ig) &&
						o.match(/^comm([0-9]+)\_prod\.([a-z0-9]+)\.([a-z0-9]+)$/ig))
					|| (host.match(/^comm([0-9]+)\_qa\.([a-z0-9]+)\.([a-z0-9]+)$/ig) &&
						o.match(/^comm([0-9]+)\_qa\.([a-z0-9]+)\.([a-z0-9]+)$/ig))
				) { 
					//if (DS[o] !== DS[host]) {    
						list[o] = DS[o];
					//}
				}
				
			}	
			return list;
		};				
		
		me.sendResponse = function (cfg, data) {
			let me = this;
			me.io.to(cfg.socketid).emit('clientRequestCBK', data);	
			me.hubService(cfg, data);
		};		
		me.hubService = function (cfg, data) {
			let me = this, clusters =  me.getCluster(cfg.host);
			var ioClient = require(env.root_path + '/package/socket.io-client/node_modules/socket.io-client');
			// ==============
			/*
			var socketNodeClient = require(env.root_path + '/package/socketNodeClient/socketNodeClient.js');
			var socketClient = new socketNodeClient(
				{link:'http://comm1.service.dev.shusiou.win/'}, 
				env);
			socketClient.sendToRoom(
			    'CRON_REPORT',
			    {x:new Date(), Y:90},
			    function(data) {
				// res.send(data);
			    }
			);	
			*/
			// ===========
			
			var CP = new pkg.crowdProcess(), _f = {};
			for(o in clusters) {
				_f[o] = function(cbk) {
					ioClient.connect('http://' + o + '/', 
							 {secure: true, reconnect: true, rejectUnauthorized : false});
					ioClient.on('connect', function(){
						cbk(123);
						ioClient.disconnect()
					});
					ioClient.on('connect_failed', function(){
					    console.log('Connection Failed');
					});
				} 
			}
			CP.serial(_f,
				function(data) {
				console.log('--data-->');
				console.log(data);
					me.io.to(cfg.socketid).emit('hubService', 
						{
							incomeData : data,
							ff : {cfg : cfg, clusterAA : clusters }
						}
					);	
				},
				3000
			);
		};
		me.io.on("connection", (socket) => {
			var host = (!socket || !socket.handshake || !socket.handshake.headers) ? '' : socket.handshake.headers.host;
			if(!host.match(/^comm([0-9]+)\_(qa|dev|prod)\.([a-z0-9]+)\.([a-z0-9]+)$/ig)) { 
				socket.disconnect();
				return true;
			} 
			var cfg = {
				socketid : socket.id,
				host : (!socket || !socket.handshake || !socket.handshake.headers) ? '' : socket.handshake.headers.host,
				query : (!socket || !socket.handshake || !socket.handshake.query) ? {} : socket.handshake.query
			};
			
			socket.on('clientRequest', function(incomeData){
				let _id = incomeData._id; 
				switch(incomeData.cmd) {
					case 'sendToRoom':
						me.io.to(incomeData.room).emit('clientMessage', {
							data: incomeData.data,
							from: socket.id,
							to : incomeData.room
						});	

						if (!incomeData.room) {
							me.sendResponse(cfg, {_id: _id,  socket_id: socket.id,
								Err : 'Missing room'});
						} else {
							socket.join(incomeData.room, function() {	
								me.io.in(incomeData.room).clients((err, clients) => {
									if (incomeData.data) {
										me.io.to(incomeData.room).emit('clientMessage', {
											data: incomeData.data,
											from: socket.id,
											to : incomeData.room
										});
									}									
									me.sendResponse(cfg, { _id: _id,  socket_id: socket.id,
									  Err: (err)? err : null, 
									result: { status: 'success',  clients : clients}});
								});
							});
						}
						break;
					case 'leaveRoom':
						socket.leave(incomeData.room,  function() {
							me.io.in(incomeData.room).clients((err, clients) => {
								me.sendResponse(cfg, { _id: _id,  socket_id: socket.id,
								  Err: (err)? err : null,
								  result: { status: 'success', clients : clients}});
							});
						});
						break;
					case 'sendToSocket':
						if (!incomeData.toSocket) {
							me.sendResponse(cfg, {_id: _id,  socket_id: socket.id,
								Err : 'Missing toSocket'});
						} else {
							me.sendResponse(cfg, {_id: _id,  socket_id: socket.id,
								Err : null, result: { status: 'success'}});
							if (incomeData.data) {
								me.io.to('/#' + incomeData.toSocket.replace(/^\/\#/, '')).emit('clientMessage', {
									data: incomeData.data,
									from: socket.id,
									to : incomeData.toSocket
								});
							}
						}
						break;	
					default : 
						me.sendResponse(cfg, {_id: incomeData._id,  socket_id: socket.id,Err : 'Missing cmd'});
				}
			});
			
			socket.on('hubService', function(incomeData){
				console.log('incomeData-hubService-->');
				console.log(incomeData);
			});
					
			sequenceNumberByClient.set(socket, 1);
			socket.on("disconnect", () => {
				sequenceNumberByClient.delete(socket);
			});
		});		
	};
	
	if (typeof module !== 'undefined' && typeof module.exports !== 'undefined') {
		module.exports = obj;
	} 
	
})();
